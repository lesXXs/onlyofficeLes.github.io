<!--
 (c) Copyright Ascensio System SIA 2020

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Entity Highlight Plugin</title>
    <script type="text/javascript" src="https://onlyoffice.github.io/sdkjs-plugins/v1/plugins.js"></script>
    <script type="text/javascript" src="https://onlyoffice.github.io/sdkjs-plugins/v1/plugins-ui.js"></script>
    <link rel="stylesheet" href="https://onlyoffice.github.io/sdkjs-plugins/v1/plugins.css">
    <script type="text/javascript" src="scripts/helloworld.js"></script>
</head>
<body>
</body>
<script>
    // 注册文档内容变化事件
    function registerDocumentContentChangeEvent() {
        window.OnPluginsReady(function(api) {
            api.document.addEventListener("contentchange", onDocumentContentChange);
        });
    }

    // 当文档内容发生变化时触发的事件处理程序
    function onDocumentContentChange(event) {
        const content = event.detail.content; // 获取文档内容
        const companies = findEntities(content, '公司'); // 查找公司实体
        const projects = findEntities(content, '项目'); // 查找项目实体

        // 高亮显示公司实体
        companies.forEach(company => {
            window.OnPluginsReady(function(api) {
                api.document.applyHighlight({
                    start: company.start,
                    end: company.end,
                    color: 'yellow'
                });
            });
        });

        // 高亮显示项目实体
        projects.forEach(project => {
            window.OnPluginsReady(function(api) {
                api.document.applyHighlight({
                    start: project.start,
                    end: project.end,
                    color: 'cyan'
                });
            });
        });
    }

    // 查找指定实体
    function findEntities(content, entity) {
        const entities = [];
        let startIndex = 0;
        let startTag = `<entity type="${entity}">`;
        let endTag = `</entity>`;

        while (true) {
            const start = content.indexOf(startTag, startIndex);
            if (start === -1) break;

            const end = content.indexOf(endTag, start + startTag.length);
            if (end === -1) break;

            const entityStart = start + startTag.length;
            entities.push({ start: entityStart, end: end });

            startIndex = end + endTag.length;
        }

        return entities;
    }

    registerDocumentContentChangeEvent();
</script>

</html>